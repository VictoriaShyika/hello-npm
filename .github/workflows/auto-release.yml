name: Release

on:
  push:
    branches:
      - test
jobs:
  version_check:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.version.outputs.changed }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Version Update
        id: version
        uses: EndBug/version-check@v2.1.4
        with:
          file-url: https://unpkg.com/@victoria-shyika/hello-npm/package.json
          static-checking: localIsNew
          
  release:
      needs: version_check
      if: needs.version_check.outputs.changed == 'true'
      runs-on: ubuntu-latest
      steps:
        - name: Create Tag and GitHub Release
          if: steps.version.outputs.changed == 'true'
          uses: actions/create-release@v1.1.4
          env:
            GITHUB_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
          with:
            tag_name: ${{ steps.version.outputs.version }}
            release_name: Release ${{ steps.version.outputs.version }}
            body: |
              Changes since ${{ steps.changes.outputs.last-tag }}:
              ${{ steps.changes.outputs.log }}

  # Custom message step when release is skipped
  - name: Release Skipped
    if: needs.version_check.outputs.changed == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Skip Annotation
        uses: actions/github-script@v5
        with:
          script: |
            const { context, GitHub } = require('@actions/github');

            const octokit = new GitHub(process.env.GITHUB_TOKEN);
            const { owner, repo } = context.repo;

            const run_id = context.runId;
            const step_id = context.job + "_" + context.runId;
            const output_id = context.workflow + "_" + context.job + "_" + context.runId;

            const annotation = {
              owner: owner,
              repo: repo,
              run_id: run_id,
              title: "Release Skipped",
              message: "No version change detected. Skipping release.",
              annotation_level: "notice",
              start_line: 0,
              end_line: 0,
              start_column: 0,
              end_column: 0
            };

            await octokit.checks.create({
              ...context.repo,
              name: context.workflow,
              head_sha: context.sha,
              annotations: [annotation]
            });
              message: "No version change detected. Skipping release.",
              annotation_level: "notice",
              start_line: 0,
              end_line: 0,
              start_column: 0,
              end_column: 0
            };

            await octokit.checks.create({
              ...context.repo,
              name: context.workflow,
              head_sha: context.sha,
              annotations: [annotation]
            });
